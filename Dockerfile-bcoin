FROM nfnty/arch-mini:latest

# Build deps
RUN pacman -Sy --noconfirm archlinux-keyring
RUN pacman -Syu --noconfirm nodejs npm unrar git python2 base-devel

ENV BCOIN_BRANCH wallet-rewrite
ENV BCOIN_REPO https://github.com/bcoin-org/bcoin.git

RUN mkdir -p /code/node_modules/bcoin /data
RUN git clone --branch $BCOIN_BRANCH $BCOIN_REPO /code/node_modules/bcoin

# Installation
WORKDIR /code/node_modules/bcoin
RUN npm install --production

# Cleanup
RUN npm uninstall node-gyp
RUN pacman -Rns --noconfirm unrar python2 && \
                rm /var/cache/pacman/pkg/*

ADD ./scripts/ /code/scripts

CMD ["node", "/code/scripts/docker-bcoin-init.js"]
